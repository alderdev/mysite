{% extends "base.html" %}

{% block content %}

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

	<script>
  $(document).ready(function(){
		$("#id_product").blur(function(){
			var account = $("#id_product").val();
      $("#description").text("");
			//var formData = {account: id};
			$.ajax
			({
				url : "/products/ajax/"+account,
				type: "GET",
				//data : formData,
				success: function(data, textStatus, jqXHR)
				{
            var start = data.indexOf("<p id='description'>", 0);
            var end = data.indexOf("</p>", start);
            var str = data.substring(start+20, end);
            $("<div id='description'>" + str + "</div>").insertAfter("#span_description");
				},
        error: function(jqXHR, exception)
        {
          alert( "Invalid Product"  );
        }
			});
		})
  });
	</script>

  <script type="text/javascript">
  function checkOnSubmit(){

    var validateflag = true;
    //檢查存檔是不是有欄位沒填

    var line_no = document.getElementById("id_line_no").value;
    var unit_price = document.getElementById("id_unit_price").value;
    
    if( line_no ==''){
      window.alert("Invalid Line Number");
      validateflag = false ;
      return false;
    }
    if( unit_price ==''){
      window.alert("Invalid Price");
      validateflag = false ;
      return false;
    }

    var product = document.getElementById("description").innerHTML;

    if( product ==''){
      window.alert("Invalid Product");
      validateflag = false ;
      return false;
    }

    if(validateflag){
      document.getElementById("myform").action = "/quotations/detailadd/";
      window.alert("Submit");

      //myform.submit();
    }else{
      return false;
    }
    return false;
  }
  </script>



  <h1>{{ title }}</h1>
<a href="/ship/export_pdf">Export PDF</a>
<p>作廢註記: {{ quotehead.invalid }}</p>
<table class="table table-bordered">
  <tr>
    <td>報價單號</td>
    <td>{{ quotehead.order_number }}</td>
    <td>報價日期</td>
    <td>{{ quotehead.ord_date | date:"Y-m-d" }}</td>
  </tr>
  <tr>
    <td>業務代表</td>
    <td>{{ quotehead.request_user }}</td>
    <td>有效日期</td>
    <td colspan="3">{{ quotehead.effective_date | date:"Y-m-d" }}</td>
  </tr>
  <tr>
    <td>客戶名稱</td>
    <td>{{ quotehead.customer.title }}</td>
    <td>幣別</td>
    <td>{{ quotehead.currency }}</td>
  </tr>
  <tr>
    <td>註記事項</td>
    <td colspan="3">{{ quotehead.comment | linebreaks  }}</td>
  </tr>

</table>

<table class="table table-striped">

  <form id ='myform' action="" method="POST" onsubmit="return checkOnSubmit()">{% csrf_token %}
  <tr>
    <th width="6%"><button type="submit" class="btn btn-primary" >Add in</button>
    </th>
    <th width="3%">
      <input id="id_quotehead" name="quotehead" size="8" type="hidden" value='{{ quotehead.id }}' cssStyle="width:20px" />
      <input id="id_line_no" name="line_no" size="4" type="text" cssStyle="width:10px" />
    </th>
    <th width="8%"><input id="id_product" name="product" size="14" type="text"  cssStyle="width:30px" /></th>
    <th width="15%"><span id="span_description"></span></th>
    <th width="6%"><span id="span_img"></span></th>
    <th width="30%"><span id="span_specification"></span></th>
    <th width="5%"><input id="id_unit_price" name="unit_price" size="8" step="any" type="number"/>
    <th ><input id="line_memo" name="line_memo" size="40"  maxlength="50" type="text" cssStyle="width:160px" />
  </tr>
</form>

  <tr>
    <th width="3%">作廢</th>
    <th width="3%">行號</th>
    <th width="8%">料號</th>
    <th width="15%">品名</th>
    <th width="4%">產品圖示</th>
    <th width="30%">規格</th>
    <th width="5%">單價</th>
    <th >註記事項</th>
  </tr>
  {% for row in quotehead.quotedetail_set.all %}
  <tr>
    <td>{{ row.invalid }}</td>
    <td>{{ row.line_no }}</td>
    <td>{{ row.product.part_number }}</td>
    <td>{{ row.product.description }}</td>
    <td>  {% if row.product.image %}
            <img src="{{ row.product.image.url }}" class="img-rectangle" height="80" width="80"/>
          {% endif %}
    </td>

    <td>{{ row.product.specification }}</td>
    <td align="right">{{ row.unit_price }}</td>
    <td>{{ row.line_memo | linebreaks | truncatechars:30 }}</td>
  </tr>
  {% endfor%}
</table>

{% endblock content %}
